<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Keegeegee - My Favorites</title>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" />
    <link rel="stylesheet" href="/vendor/border-box.css" />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/favorites.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@400;500;600;700;800&family=Spectral:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet">

    <script src="/vendor/jquery-3.0.0.js"></script>
    <script defer src="/scripts/app.js"></script>
  </head>

  <body>

    <%- include('partials/_header') %>

    <div class="container">
      <div class="header">
        <h1>My Favorites</h1>
        <form id="sortForm">
          <select name="sortby" onchange="document.getElementById('sortForm').submit();">
            <option value="default">Sort By</option>
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
            <option value="date_asc">Date: Old to New</option>
            <option value="date_desc">Date: New to Old</option>
            <option value="availability">Availability</option>
          </select>
        </form>
      </div>
      <div id="hidden-length" hidden="hidden" class="info">
        <%= favorites.length %>
      </div>
      <% favorites.forEach(function(item) { %>
        <div id="hidden-userid" hidden="hidden" class="info">
          <%= item.user_id %>
        </div>
        <div class="card">
          <div class="card-image-container">
            <img src="<%= item.image_url %>" alt="Item image" class="card-image" />
          </div>
          <div class="card-info-container">
            <div class="card-info title-status">
              <h5>
                <%= item.title %> : $<%= item.price %>
              </h5>
              <% if(item.status) { %>
                <span class="status <%= item.status.toLowerCase() %>">
                  <%= item.status %>
                </span>
                <% } else { %>
                  <span class="status">No Status</span>
                  <% } %>
            </div>
            <div class="card-info description">
              <p>
                <%= item.description %>
              </p>
            </div>
            <div class="card-info date-icons">
              <span>
                <%= item.created_at.getFullYear() %>-<%= (item.created_at.getMonth() + 1) %>-<%= item.created_at.getDate() %> by <%= item.username %>
              </span>
              <div class="icons">
                <!-- Add icon elements here -->
              </div>
              <button class="delete-button" data-id="<%= item.id %>">
                Delete
              </button>
            </div>
          </div>
        </div>
        <% }); %>
          <button id="load-more" class="btn-load-more">Load more</button>
    </div>
    <script>
      // This script will submit the form when you change the selection.
      // Actual sorting logic will be handled server-side.
      document
        .getElementById("sortForm")
        .addEventListener("change", function () {
          this.submit();
        });

      const delBtns = document.querySelectorAll(".delete-button");
      // console.log(delBtns);
      delBtns.forEach((item) => {
        item.addEventListener("click", function () {
          const favId = item.getAttribute("data-id");
          console.log("favId");
          console.log(favId);
          $.ajax({
            url: `/api/fav/${favId}`,
            method: "DELETE",
            success: function (response) {
              if (response.success) {
                $(`button[data-id='${favId}']`).closest(".card").remove();
              }
            },
            error: function (error) {
              console.error("Error:", error);
            },
          });
        });
      });

      function doDelete(_id) {
        console.log("abcd", _id);
        $.ajax({
          url: `/api/fav/${_id}`,
          method: "DELETE",
          success: function (response) {
            if (response.success) {
              $(`button[data-id='${_id}']`).closest(".card").remove();
            }
          },
          error: function (error) {
            console.error("Error:", error);
          },
        });
      }
    </script>
    <script>
      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function () {
          window.location.reload();
        });
      });
    </script>
    <script>
      document.getElementById('load-more').addEventListener('click', function () {
        // after load-more button click, trigger get("/fav/favorites")
        console.log(`hidden-length.innerText = ${document.getElementById('hidden-length').innerText}`);
        const increaseRowLength = 10;
        const userId = document.getElementById('hidden-userid').innerText
        const rowLimit = Number(document.getElementById('hidden-length').innerText) + increaseRowLength
        console.log("userId, rowLimit");
        console.log(userId, rowLimit);
        const _url = `/fav/favorites/${userId}/${rowLimit}`
        console.log(_url);
        window.location.href = _url;
      });
    </script>
  </body>

</html>